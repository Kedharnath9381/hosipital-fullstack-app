name: Deploy Hospital Fullstack App on EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:   # allow manual run from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # Step 1: Checkout repo
      - name: Checkout Repo
        uses: actions/checkout@v4

      # Step 2: Debug - list files in repo
      - name: List repo files
        run: |
          echo "=== Project Structure ==="
          ls -la
          echo "=== Backend Contents ==="
          ls -la Backend-CICD/
          echo "=== Frontend Contents ==="
          ls -la Frontend-CICD/
          echo "=== Docker Files ==="
          ls -la docker-git-fullstackapp/

      # Step 3: Copy files to EC2
      - name: Copy repo to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ec2-user   # âœ… Amazon Linux user
          key: ${{ secrets.AWS_SSH_KEY }}
          source: "./*"
          target: /home/ec2-user/cicd-app
          overwrite: true

      # Step 4: SSH into EC2 and deploy with Docker Compose
      - name: Deploy on EC2 with Docker Compose
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ec2-user    # âœ… Amazon Linux user
          key: ${{ secrets.AWS_SSH_KEY }}
          script_stop: true
          debug: true
          script: |
            set -e  # Exit on error
            
            echo "ğŸš€ Starting deployment..."
            cd /home/ec2-user/cicd-app

            # Install Docker if missing (Amazon Linux 2023)
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo yum update -y
              sudo yum install docker -y
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -a -G docker ec2-user
            fi

            # Install Docker Compose if missing
            if ! command -v docker-compose &> /dev/null; then
              echo "Installing Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi

            # Install Git if missing
            if ! command -v git &> /dev/null; then
              echo "Installing Git..."
              sudo yum install git -y
            fi

            echo "âœ… Dependencies installed successfully!"

            # Navigate to docker directory
            cd docker-git-fullstackapp

            # Stop old containers, rebuild, and restart
            echo "ğŸ³ Stopping old containers..."
            sudo docker-compose down || true

            echo "ğŸ—ï¸ Building new containers..."
            sudo docker-compose build --no-cache

            echo "ğŸš€ Starting services..."
            sudo docker-compose up -d

            echo "â³ Waiting for services to start..."
            sleep 30

            # Health checks
            echo "â¤ï¸ Running health checks..."
            sudo docker ps

            # Test frontend
            if curl -s -f http://localhost:80/ >/dev/null; then
              echo "âœ… Frontend is running on port 80"
            else
              echo "âš ï¸ Frontend health check failed"
            fi

            # Test backend
            if curl -s -f http://localhost:5050/actuator/health >/dev/null; then
              echo "âœ… Backend is healthy on port 5050"
            else
              echo "âš ï¸ Backend health check failed"
            fi

            echo "ğŸ‰ Deployment completed successfully!"