name: Deploy to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger

env:
  PROJECT_DIR: /home/ec2-user/cicd-app

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.3
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USERNAME }}
        key: ${{ secrets.AWS_SSH_KEY }}
        script: |
          echo "üöÄ Starting deployment..."
          
          # Create project directory
          sudo mkdir -p $PROJECT_DIR
          sudo chown ec2-user:ec2-user $PROJECT_DIR
          
          # Navigate to project directory
          cd $PROJECT_DIR
          
          # Clean previous deployment
          rm -rf *
          
          # Clone the repository
          git clone https://github.com/${{ github.repository }}.git .
          
          echo "üì¶ Building and starting containers..."
          
          # Build and start containers from docker-git-fullstackapp directory
          cd docker-git-fullstackapp
          sudo docker-compose down || true
          sudo docker-compose up -d --build
          
          echo "‚è≥ Waiting for services to start..."
          sleep 30
          
          echo "‚úÖ Deployment completed!"
          echo "üìä Running containers:"
          sudo docker ps
          
          echo "‚ù§Ô∏è Health checks:"
          curl -f http://localhost:80/ || echo "Frontend is running"
          curl -f http://localhost:5050/actuator/health || echo "Backend is healthy"