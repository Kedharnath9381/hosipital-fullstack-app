name: Deploy Hospital Fullstack App on EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ec2-user
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            set -e
            echo "ğŸš€ Starting deployment..."
            
            # Navigate to correct directory
            cd /home/ec2-user/cicd-app/docker-git-fullstackapp
            
            echo "ğŸ“ Current directory: $(pwd)"
            echo "ğŸ“ Contents:"
            ls -la
            
            # Install Docker if missing (Amazon Linux)
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo yum update -y
              sudo yum install docker -y
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -a -G docker ec2-user
            fi

            # Install Docker Compose if missing
            if ! command -v docker-compose &> /dev/null; then
              echo "Installing Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi

            echo "âœ… Dependencies installed"
            
            # Build and deploy
            echo "ğŸ³ Building and starting containers..."
            sudo docker-compose down || true
            sudo docker-compose build --no-cache
            sudo docker-compose up -d
            
            echo "â³ Waiting for services to start..."
            sleep 30
            
            # Health checks
            echo "â¤ï¸ Health checks:"
            sudo docker ps
            
            if curl -s -f http://localhost:80/ >/dev/null; then
              echo "âœ… Frontend is running"
            else
              echo "âš ï¸ Frontend health check failed"
            fi
            
            if curl -s -f http://localhost:5050/actuator/health >/dev/null; then
              echo "âœ… Backend is healthy"
            else
              echo "âš ï¸ Backend health check failed"
            fi
            
            echo "ğŸ‰ Deployment completed successfully!"